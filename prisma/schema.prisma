// Archivo: prisma/schema.prisma

// ------------------------------------------------------------------------
// 1. CONFIGURACI칍N B츼SICA
// ------------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------------------------------------
// 2. ENUMS (Estados y Tipos)
// ------------------------------------------------------------------------

enum Role {
  CLIENT
  ADMIN
  TECNICO
}

enum ProductCondition {
  NEW
  USED
  REFURBISHED
}

enum RepairStatus {
  PENDIENTE
  EN_DIAGNOSTICO
  ESPERANDO_REPUESTO
  EN_REPARACION
  LISTO
  ENTREGADO
  CANCELADO
}

enum OrderStatus {
  PENDIENTE_PAGO
  PAGADO
  ENVIADO
  ENTREGADO
  CANCELADO
}

// ------------------------------------------------------------------------
// 3. MODELOS
// ------------------------------------------------------------------------

// --- USUARIOS Y PERFIL ---

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password      String
  name          String?
  role          Role      @default(CLIENT)
  phone         String?   // 칔til para contacto r치pido en reparaciones
  
  // Relaciones
  addresses     Address[]
  orders        Order[]
  repairs       RepairTicket[]
  reviews       Review[]
  cart          Cart?     // Un usuario tiene un carrito activo

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Direcciones guardadas en el perfil del usuario
model Address {
  id            Int     @id @default(autoincrement())
  street        String
  city          String
  state         String
  zipCode       String
  country       String
  isDefault     Boolean @default(false)
  
  userId        Int
  user          User    @relation(fields: [userId], references: [id])
}

// --- CATALOGO DE PRODUCTOS ---

model Brand {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  slug      String    @unique
  imageUrl  String?   
  products  Product[]
}

model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  slug      String    @unique 
  imageUrl  String?

  // Relaci칩n recursiva para Subcategor칤as (Ej: Computaci칩n -> Laptops)
  parentId  Int?
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")

  products  Product[]
}

// El "Padre" del producto (Ej: "iPhone 13")
// Contiene la info general que comparten todas las variantes
model Product {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique              
  description String?
  
  // Especificaciones t칠cnicas generales (JSON)
  // Ej: { "screen": "6.1 OLED", "camera": "12MP" }
  specs       Json?    
  
  // Relaciones
  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])
  brandId     Int
  brand       Brand    @relation(fields: [brandId], references: [id])

  variants    ProductVariant[]
  reviews     Review[]

  isFeatured  Boolean  @default(false)
  discount    Int      @default(0) // Porcentaje de descuento (ej: 15 para 15%)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// La "Variante" f칤sica (Ej: "iPhone 13 - Azul - 128GB - Nuevo")
// Aqu칤 es donde manejamos el stock y precio real
model ProductVariant {
  id           Int              @id @default(autoincrement())
  sku          String           @unique // C칩digo 칰nico de inventario
  price        Decimal          @db.Decimal(10, 2)
  stock        Int              @default(0)
  
  // Atributos espec칤ficos
  color        String?          // Ej: "Midnight Blue"
  storage      String?          // Ej: "128GB", "1TB"
  condition    ProductCondition @default(NEW)
  
  // Im치genes espec칤ficas de esta variante (ej: foto del celular azul)
  images       String[]         

  productId    Int
  product      Product          @relation(fields: [productId], references: [id])
  
  orderItems   OrderItem[]
  cartItems    CartItem[]
}

// Sistema de Rese침as
model Review {
  id        Int      @id @default(autoincrement())
  rating    Int      @default(5) // 1 a 5 estrellas
  comment   String?
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  productId Int
  product   Product  @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
}

// --- CARRITO DE COMPRAS (Opcional pero recomendado) ---

model Cart {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id])
  items     CartItem[]
  updatedAt DateTime @updatedAt
}

model CartItem {
  id        Int            @id @default(autoincrement())
  quantity  Int
  cartId    Int
  cart      Cart           @relation(fields: [cartId], references: [id])
  
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id])
}

// --- VENTAS Y PEDIDOS ---

model Order {
  id              Int         @id @default(autoincrement())
  total           Decimal     @db.Decimal(10, 2)
  status          OrderStatus @default(PENDIENTE_PAGO)
  
  // 游댠游댠游댠 CAMBIO IMPORTANTE AQU칈 游댠游댠游댠
  // Agregamos '?' para permitir compras sin estar logueado (Invitados)
  userId          Int?
  user            User?       @relation(fields: [userId], references: [id])
  
  items           OrderItem[]
  
  // Informaci칩n de env칤o CONGELADA (Snapshot)
  shippingAddress Json      // { "street": "...", "city": "...", "zip": "..." }
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model OrderItem {
  id          Int            @id @default(autoincrement())
  quantity    Int
  price       Decimal        @db.Decimal(10, 2) // Precio al momento de la compra
  
  orderId     Int
  order       Order          @relation(fields: [orderId], references: [id])
  
  variantId   Int
  variant     ProductVariant @relation(fields: [variantId], references: [id])
}

// --- SISTEMA DE REPARACIONES (SAT) ---

model RepairTicket {
  id               String       @id @default(uuid())
  trackingCode     String       @unique @default(cuid()) // C칩digo corto para que el cliente consulte
  
  deviceModel      String       // Ej: "PlayStation 5", "iPhone X"
  serialNumber     String?      // Importante para no confundir dispositivos iguales
  issueDescription String
  
  status           RepairStatus @default(PENDIENTE)
  
  estimatedCost    Decimal?     @db.Decimal(10, 2)
  finalCost        Decimal?     @db.Decimal(10, 2)
  
  contactPhone     String?      
  internalNotes    String?      // Notas solo para t칠cnicos
  
  userId           Int?
  user             User?        @relation(fields: [userId], references: [id])
  
  logs             RepairLog[]  // Historial de cambios de estado
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

// Historial de la reparaci칩n (Trazabilidad)
model RepairLog {
  id        Int          @id @default(autoincrement())
  ticketId  String
  ticket    RepairTicket @relation(fields: [ticketId], references: [id])
  
  status    RepairStatus // El estado al que cambi칩
  note      String?      // Ej: "Se pidi칩 el repuesto a proveedor X"
  createdAt DateTime     @default(now())
}